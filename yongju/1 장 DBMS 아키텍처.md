# 공부 목표

- RDB의 내부적인 동작 모델을 공부합니다.
- 데이터 캐시와 워킹 메모리 등의 메모리 구조, 저장소 구조를 알아봅니다.
- SQL 퍼포먼스를 위한 '실행 계획'과 옵티마이저를 알아봅니다.
  <br/><br/><br/><br/>

# DBMS 아키텍처

<img width="400" alt="사진2" src="https://github.com/KimYongJ/SQL-level-up/assets/106525587/f6902ac8-c5b6-466b-9710-0ee489f894e3">

<br/><br/>

## 1. 쿼리 평가 엔진

- 데이터베이스에 어떻게 접근할지 계획을 세우고 실행하는 DBMS의 핵심 기능을 담당하는 모듈입니다.
- 쿼리 평가 엔진은 사용자에게 입력받은 SQL 구문 분석 및 어떤 순서로 기억장치의 데이터에 접근할지 결정합니다.( 이때 결정되는 계획이 바로 '실행 계획'입니다.)
- 실행 계획에 기반을 두고 데이터에 접근하는 방법을 '접근 메서드'라고 부릅니다.

<br/>

## 2. 버퍼 매니저

- 개요 : 버퍼라는 메모리를 관리하는 역할을 합니다. 버퍼 매니저는 디스크를 관리하는 디스크 용량 매니저와 함께 연동되어 작동합니다.

<br/>

### DBMS와 버퍼

<img width="368" alt="사진2" src="https://github.com/KimYongJ/SQL-level-up/assets/106525587/27481d14-1055-4369-a5b2-b3085d4562db">


- DBMS는 데이터 저장을 목적으로하는 미들웨어 입니다. DBMS가 사용하는 대표적인 기억장치는 하드디스크(2차 계층 기억장치), 메모리(1차 계층 기억장치)가 있습니다.
  - 하드디스크 : 메모리에 비해 기억 비용이 저렴합니다.
  - 메모리 : 속도가 빠르지만 하드디스크에 비해 메모리 기억비용이 많이 듭니다.
  - 버퍼 : 버퍼(buffer) 혹은 캐시(cache)는 성능 향상을 목적으로 데이터를 저장하는 메모리를 의미합니다. 메모리에 데이터를 올려 놓는 이유는 SQL 실행 속도를 향상시키기 위함입니다. 자주 접근하는 데이터를 메모리에 올려두면 같은 SQL 구문을 실행한다 하면 디스크보다 메모리에서 데이터를 가져오는 것이 빠릅니다.
  - 버퍼매니저 : 고속 접근이 가능한 버퍼(메모리)에 데이터를 어떻게, 어느 시간동안 올릴지를 관리하는 것입니다.
- DBMS는 데이터를 유지하기 위해 사용하는 메모리는 데이터 캐시와 로그 버퍼가 있습니다.
  - 데이터 캐시 : 데이터의 일부를 저장하는 메모리 영역입니다. 만약 우리가 실행할 SELECT 구문에서 선택하고픈 데이터가 데이터 캐시에 있다면 디스크와 같은 저속 저장소에 접근하지 않고 굉장히 빠르게 수행됩니다.
  - 로그 버퍼 : 갱신 처리(INSERT, DELETE, UPDATE, MERGE)와 관련있습니다. DBMS는 갱신 요청이 왔을 때 바로 적용하지 않고 로그 버퍼에 갱신 정보를 보낸 후 디스크에 변경을 적용합니다. 그 이유는 갱신에 대해 하나하나씩 처리하는 것보다 한번에 몰아서 처리하는 것이 더 빠르기 때문입니다.
  - 로그 버퍼와 데이터 캐시의 관리 : 물리 메모리를 할당할 때 보통 데이터 캐시로 사용하는 물리메모리 공간이 훨씬 높습니다. 하지만 갱신에 대해 많은 처리를하는 서버라면, 로그 버퍼의 물리메모리 사용공간을 더 늘려주는 것이 효율성이 높을 수 있습니다.
- 워킹 메모리
  - DBMS는 로그 버퍼, 데이터 캐시 이외에도 워킹 메모리를 갖고 있습니다.
  - 워킹 메모리는 정렬이나 해시 관련 처리에 사용되는 작업용 영역입니다. 작업시 사용되고 종료도면 해제되는 임시 영역입니다.
    - 정렬 : ORDER BY 구절, 집합 연산, 윈도우 함수등의 기능을 사용할 때 실행됩니다.
    - 해시 : 주로 테이블등의 결합에서 해시 결합이 사용될 때 실행됩니다.

<br/>

## 3. 디스크 용량 매니저

- 디스크 용량 매니저는 데이터를 영구적으로 저장하기 위해 하드웨어 어디에 어떻게 데이터를 저장할지를 관리하며 데이터의 읽고 쓰기를 제어합니다.

<br/>

## 4. 트랜잭션 매니저와 락 매니저

- 여러 사람이 동시에 하나의 데이터베이스에 접근하려할 때 각각의 처리는 DBMS 내부에서 트랜잭션이라는 단위로 관리합니다. 이런 트랜잭션의 정합을 유지하며 필요에 따라 데이터에 락을 걸어 다른 사람의 요청을 대기시키는 것이 트랜잭션 매니저와 락 매니저의 역할입니다.

<br/>

## 5. 리커버리 매니저

- 시스템 장애시 복구를 위해 데이터를 정기적으로 백업하고 복구하는 역할을 수행하는 것이 리커버리 매니저입니다.

<br/><br/><br/>

# DBMS와 실행 계획

- RDB에서 데이터 접근 절차를 결정하는 모듈은 쿼리 평가 엔진이라고 부릅니다. 쿼리가 어떻게 처리되고, 실제로 데이터 접근이 이루어지는지는 아래 그림으로 볼 수 있습니다.

<img width="516" alt="사진3" src="https://github.com/KimYongJ/SQL-level-up/assets/106525587/b7cd16f3-7c9d-4ffe-b5be-f79dbf2b672f">


  - 파서(Parser)
    - 파서는 구문 분석을 하는 것입니다. 사용자가 없는 테이블을 요청하거나, 쉼표를 쓰지 않았거나 할 경우 알려 줍니다. 또한 DBMS에서 요청에 대한 후속 처리의 효율을 높이기 위해 SQL구문을 정형화 합니다.
  - 옵티마이저(Optimizer, 최적화)
    - 옵티마이저는 DBMS의 두뇌라 할 수 있습니다. 파서를 통과한 후 옵티마이저로 데이터가 전달 되면 옵티마이저에서 실행 계획(데이터 접근방법)을 최적화합니다.
    - 옵티마이저에서 인덱스 유무, 데이터 분산 OR 편향 정도, DBMS 내부 매개변수 등 조건을 고려해서 선택할 수 있는 많은 실행계획(플랜생성)을 작성하고 이들의 비용을 연산(비용 평가)해 가장 낮은 비용을 가진 실행 계획을 선택합니다.
  - 카탈로그 매니저(Catalog manager)
    - 카탈로그란 DBMS 내부 정보를 모아 놓은 테이블들로써 테이블 또는 인덱스의 [통계 정보]가 저장되어 있습니다.
    - 옵티마이저가 실행계획을 세울 때 이 [통계 정보]를 제공하는 것이 카탈로그 매니저 입니다.
    - 카탈로그에 포함되어 있는 정보는 다음과 같습니다.
      - (1) 각 테이블의 레코드 수
      - (2) 각 테이블의 필드 수와 필드의 크기
      - (3) 필드의 카디널리티(값의 개수)
      - (4) 필드값의 히스토그램(어떤 값이 얼마나 분포되어 있는가)
      - (5) 필드 내부에 있는 NULL의 수
      - (6) 인덱스 정보
  - 플랜 평가(plan evaluation)
    - 옵티마이저가 세운 많은 실행계획 중 최적의 실행 계획을 선택하는 것이 플랜 평가 입니다.
  - 옵티마이저와 통계 정보
    - 옵티마이저는 항상 최적의 실행 계획을 선택하는 것이 아닙니다. 그 이유 중 대표적인 것이 통계 정보의 부족입니다. 예를 들어 카탈로그의 정보가 실제 테이블 또는 인덱스의 실제와 일치하지 않을 때 입니다. 이 경우 데이터가 CRUD되었을 때 카탈로그 정보가 갱신되지 않으면 발생합니다. 이 때 옵티마이저는 오래전 정보를 바탕으로 실행 계획을 세우게 되어 최적의 실행계획이 아닐 수 있습니다.

- 실행 계획 살펴 보기
  - SQL 명령어의 실행 계획을 살펴보기 위해서는 각 DBMS마다 해당하는 명령어 입력 후 쿼리를 실행해주면됩니다. 예시로 PostgreSQL은 EXPLAIN 입력 후 SQL 구문을 실행하거나, 오라클은 set autotrace traceonly 명령어 입력 후 SQL 구문을 실행합니다.
  - 위와 같이 명령어를 입력한 후 화면에 출력된 실행 계획을 보면 공통적으로 보여주는 부분은 3가지 입니다. (1) 조작 대상 객체, (2) 객체에 대한 조작의 종류, (3) 조작 대상이 되는 레코드 수 입니다.
    - (1) 조작 대상 객체 : 말그대로 조작하는 객체이며 조회할 때 테이블 명이라던가, 인덱스, 파티션, 시퀀스 처럼 SQL 구문으로 조작할 수 있는 객체라면 어떤 것이든 올 수 있습니다.
    - (2) 객체에 대한 조작의 종류 : 예를들어 Seq Scan이라고 종류가 나온다면 파일을 순차적으로 접근해서 해당 테이블의 데이터 전체를 읽어낸다는 것을 의미합니다. 이 조작의 종류는 실행계획에서 가장 중요한 부분입니다.
    - (3) 조작 대상이 되는 레코드 수 : Rows라는 항목에 출력이 되며 처리되는 행의 개수입니다.
